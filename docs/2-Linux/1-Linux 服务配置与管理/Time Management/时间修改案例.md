---
title: 时间修改案例
sidebar_position: 3
---

集群环境时间一致性非常重要，集群时间的一致性影响整个产品功能是否正常使用。

下面将针对整个时间配置流程以及部署完成后的环境时间修改进行详细的介绍和说明。	


主要涉及到数据备份，时间检查，时间向过去修改、时间向未来修改和NTPServer对接配置几个过程，具体怎么操作需要根据现场的清理进行处理，建议严格按照如下流程图进行判断和时间修改。
    1、 数据备份
    2、 时间修改
    3、 NTPServer对接配置（无NTPServer对接配置可以省略这个步骤）


## 数据备份

集群时间修改存在一定的风险，需要在操作前进行数据备份。
备份Mysql数据以及Param-etcd数据

### MySql数据手工备份方法

    1) 找到mysql集群的主节点
    2) 获取mysql主节点Pod的IP地址
    3) 使用mysqldump命令备份
通过下图可看到：mysql-node2是Master
```bash
root@host:/root# maxadmin list servers
Servers.
-------------------+-----------------+-------+-------------+--------------------
Server             | Address         | Port  | Connections | Status              
-------------------+-----------------+-------+-------------+--------------------
server1            | mysql-node1     |  3306 |         560 | Slave, Running
server2            | mysql-node2     |  3306 |         560 | Master, Running
server3            | mysql-node3     |  3306 |         560 | Slave, Running
-------------------+-----------------+-------+-------------+--------------------
```
通过mysqldump命令备份
```bash
mysqldump -uroot -pcloudos –h<Mysql主节点的IP> --all-databases >mysqlDump_`date +"%Y%m%d_%H%M%S_%s"`.sql
```

### Param-etcd参数容器数据后台手工备份方法

后台手工备份，仅备份的是param-etcd的数据，其备份方法如下：
    1) param-etcd服务正常运行的节点；
    2) 任一param-etcd健康的节点备份数据。
A．停止param-etcd服务；
B．备份param-etcd数据；
C．重启param-etcd服务；
D．拷贝备份的文件到本地。

```bash
/opt/bin/etcdctl --endpoint=127.0.0.1:2369 cluster-health

member 14cd649c017b2293 is healthy: got healthy result from http://172.25.18.104:2369
member 2cc237eb7ca30ddb is healthy: got healthy result from http://172.25.18.103:2369
```
可以看到每个节点都是健康的。在任一Param-etcd健康的节点，备份数据
- 停止param-etcd服务 `systemctl stop param-etcd`
- 备份param-etcd数据
    备份方法为：拷贝<该节点IP>.etcd路径下的文件到本地备份目录即可 `cp –rf /<该节点IP>.etcd/*  指定备份文件夹`
- 重启param-etcd服务 `systemctl start param-etcd`

### PostgreSQL数据后台手工备份方法
    1) 停止PostgreSQL的SVC服务
    2) 重启PostgreSQL的POD
    3) 备份PostgreSQL的数据
    4) 启动PostgreSQL的SVC

停止PostgreSQL的SVC服务，该操作是避免其他服务访问PostgreSQL ，相关命令如下：
```bash
source  /opt/bin/common/tool.sh
kubectl delete -f /opt/bin/confFile-cluster/postgresql-service.yaml
```
重启PostgreSQL的POD，该操作是端开已经存在的连接，相关命令如下：
```bash
/opt/bin/kubectl --server=127.0.0.1:8888 scale rc postgresqlrc --replicas=0
/opt/bin/kubectl --server=127.0.0.1:8888 scale rc postgresqlrc --replicas=1
```

备份postgresql数据，相关命令如下：
```bash
export PGPASSWORD=cloudos;pg_dumpall -U postgres -h <步骤3获取的POD的IP地址> -c -f /root/pg_bak-$(date +%y%m%d%H%M%S).bak
```



## 环境时间检查

修改环境的时间时，需要确定时间是向未来修改，还是向过去修改。时间向过去修改和向未来修改的操作流程是不一样的，因此这个检查非常重要。


### 环境时间向过去修改方案
CloudOS环境的时间向过去修改，操作流程如下：
    1) 停止CloudOS所有服务
先查询到所有rc：
`/opt/bin/kubectl -s 127.0.0.1:8888 get rc`
依次停止所有rc的服务：
`/opt/bin/kubectl -s 127.0.0.1:8888 scale --replicas=0 rc xxxxxrc`
    2) 等待所有pod停止后，修改所有服务器的系统时间
查询pod方法：
`/opt/bin/kubectl -s 127.0.0.1:8888 get pod -o wide`
修改时间方法：
方法1： date --set "1/1/09 00:01" 月/日/年时:分:秒）
方法2：停止ntpd服务后通过ntpdate x.x.x.x修改时间
```bash
[root@e1139h06-m ~]# systemctl stop ntpd.service 
[root@e1139h06-m ~]# ntpdate 172.25.48.31
18 Jul 15:10:03 ntpdate[30097]: adjust time server 172.25.48.31 offset 0.000062 sec
[root@e1139h06-m ~]# systemctl start ntpd.service
```


    3) 删除基于时间的注册数据
```
[root@e1139h06-m ~]# /opt/bin/etcdctl rm /kubeapiMaster
PrevNode.Value: 1139h06up-C2
```
    1) 重启所有服务器
    2) 所有服务器启动完毕后，启动CloudOS所有服务
依次启动所有rc的服务（建议按顺序：db、rmqp、etcd、openstack、core、web、其他）：
`/opt/bin/kubectl --server=127.0.0.1:8888 scale --replicas=1 rc xxxxxrc`

### 环境时间向未来修改

CloudOS环境的时间向未来修改，操作流程如下：
    1) 停止CloudOS所有服务
先查询到所有rc：
`/opt/bin/kubectl -s 127.0.0.1:8888 get rc`
依次停止所有rc的服务：
`/opt/bin/kubectl -s 127.0.0.1:8888 scale --replicas=0 rc xxxxxrc`
    2) 等待所有pod停止后，修改所有服务器的系统时间
查询pod方法：
`/opt/bin/kubectl -s 127.0.0.1:8888 get pod -o wide`
修改时间方法：
方法1： date --set "1/1/09 00:01" 月/日/年时:分:秒）
方法2：停止ntpd服务后通过ntpdate x.x.x.x修改时间
```bash
[root@e1139h06-m ~]# systemctl stop ntpd.service 
[root@e1139h06-m ~]# ntpdate 172.25.48.31
18 Jul 15:10:03 ntpdate[30097]: adjust time server 172.25.48.31 offset 0.000062 sec
[root@e1139h06-m ~]# systemctl start ntpd.service
```
    3) 删除基于时间的注册数据
/opt/bin/etcdctl rm /kubeapiMaster
    4) 重启kubernetes的网络服务

```bash
ansible all -m shell -a 'systemctl restart kube-flanneld.service'
```
    5) 检查kubernetes和容器网络是否一致，如果不一致，**重启不一致节点的docker服务**  
        A、Flannel网络与Docker网络一致性检查;  
        检查命令（每个节点执行）：  
        ```bash
        cat /run/flannel/subnet.env && ps -ef | grep bip
        ```
        Flannel网络与Docker网络一致性检查实例，以其中一个节点为例：
        ```bash
        [root@heccloud01 ~]# cat /run/flannel/subnet.env && ps -ef | grep bip
        FLANNEL_NETWORK=10.101.0.0/16
        FLANNEL_SUBNET=10.101.44.1/24  ## 这里
        FLANNEL_MTU=1500
        FLANNEL_IPMASQ=false
        root      3323     1 32 May20 ?        2-17:47:24 /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --insecure-registry=172.25.18.103:9999 --bip=10.101.44.1/24 --mtu=1500  ## 这里--storage-driver=devicemapper --storage-opt dm.datadev=/dev/centos/data --storage-opt dm.metadatadev=/dev/centos/metadata --log-opt max-size=1g --log-opt max-file=2
        root     32322 17022  0 17:14 pts/2    00:00:00 grep --color=auto bip
        ```

    6) 所有服务器启动完毕后，启动CloudOS所有服务
依次启动所有rc的服务（建议按顺序：db、rmqp、etcd、openstack、core、web、其他）：
/opt/bin/kubectl --server=127.0.0.1:8888 scale --replicas=1 rc xxxxxrc
    1) 检查业务功能。