---
title: 常用命令
tags: [Linux 时间管理]
sidebar_position: 1
---
 tzdata:
sudo timedatectl set-timezone "Asia/Shanghai"
sudo date -s "2023-02-21 09:58:20"


要注意的是，ntpd 有一个自我保护设置:如果本机与上源时间相差太大, ntpd 不运行. 所以新设置的时间服务器一定要先 ntpdate 从上源取得时间初值, 然后启动 ntpd 服务。ntpd 服务运行后, 先是每 64 秒与上源服务器同步一次, 根据每次同步时测得的误差值经复杂计算逐步调整自己的时间, 随着误差减小, 逐步增加同步的间隔. 每次跳动, 都会重复这个调整的过程.
- 运行 ntpd -qg 手动同步网络时钟，忽略本地 UTC 和网络 UTC 之间的大偏差。
  -g 开关，以允许 NTPD 进行第一次更新，这或多或少等同于在启动 NTPD 之前运行一次 ntpdate，这曾经是推荐的做法。
设置完时区后，在强制同步下系统时钟$ chronyc -a makestep
## timedatectl
>查看当前时间/日期/时区：timedatectl 或者 timedatectl status
>查看所有可用时区：timedatectl list-timezones
>设置时区：timedatectl set-timezone "时区" 例如：timedatectl set-timezone Asia/Shanghai
>设置日期时间：timedatectl set-time "YYYY-MM-DD HH:MM:SS"
设置硬件时钟为本地时间：timedatectl set-local-rtc 1
>设置硬件时钟为 UTC 时间：timedatectl set-local-rtc 0
>启动 NTP 时间同步(启用 NTP 服务或者 Chrony 服务)：timedatectl set-ntp true
>禁用 NTP 时间同步：timedatectl set-ntp false

1. 修改当前日期时间

```bash
# 可以只修改其中一个
$ timedatectl set-time "YYYY-MM-DD HH:MM:SS"
$ timedatectl set-time "2019-10-31 15:50:00"
```

1. 设置硬件时间

```bash
# 硬件时间默认为 UTC，下面两条命令效果等同
$ timedatectl set-local-rtc 1
$ hwclock --systohc --localtime
```

1. 启用或者禁止 NTP 时间同步

```bash
# yes 或 no，1 或 0 也可以
$ timedatectl set-ntp yes/no
$ timedatectl set-ntp true/flase
```

```bash
	查看日期时间、时区及NTP状态：timedatectl
	查看时区列表：timedatectl list-timezones
	修改时区：timedatectl set-timezone Asia/Shanghai
	修改日期时间：timedatectl set-time “2017-01-23 10:30:00”
	开启NTP： timedatectl set-ntp true/flase
	system-config-date：图形化配置chrony服务的工具
```



- System clock synchronized”： “system clock synchronized”系统验证所有系统时钟是否同步。
- NTP 服务： “NTP”(网络时间协议)允许用户同步网络内的所有系统时钟。
- RTC in local TZ：表示当前Linux系统使用本地时区。
可以使用 timedatectl 命令查询和设置硬件时钟。你可以看到 Arch 系统当前的硬件时钟标准使用:

:::info
- Timedatectl 的使用需要一个活动的 D-Bus。因此，可能无法在 chroot 下使用此命令(例如在安装期间)。在这些情况下，您可以恢复到 hwlock 命令，或者使用 systemd-nspawn 代替 chroot。
- 如果/etc/adjtime 不存在，Systemd 假设硬件时钟设置为 UTC。
:::

```bash
$timedatectl | grep local
RTC in local TZ: no
```
若要将硬件时钟时间标准更改为本地时间，请使用:
```bash
# timedatectl set-local-rtc 1
```
要恢复到以 UTC 为单位的硬件时钟，输入:
```bash
# timedatectl set-local-rtc 0
```
它们自动生成/etc/adjtime 并相应地更新 RTC; 不需要进一步的配置。
### 读取 Hardware clock 硬件时钟
```
sudo hwclock --show
```
### 从系统时钟设置硬件时钟
将 System clock 写入 Hardware clock。它将会创建并更新 /etc/adjtime 。有关此文件详细信息请参见 [hwlock (8) The Adjtime File](https://man.archlinux.org/man/hwclock.8#The_Adjtime_File)。

```
sudo hwclock --systohc
```

查看时钟  
	要检查当前系统时钟时间(以本地时间和 UTC 表示)以及 RTC (硬件时钟) :
```bash
timedatectl
```
设置系统时钟
```bash
# timedatectl set-time "yyyy-MM-dd hh:mm:ss"
timedatectl set-time "2023-02-21 10:16:54"

Failed to set time: Automatic time synchronization is enabled
timedatectl set-ntp no
如果要恢复ntp 自动校时，则执行：
timedatectl set-ntp yes
查看当前操作系统时间
```
## date
```bash
	直接调用 date，得到的是本地时间。
	如果想得到UTC时间的话，使用 date -u。
	修改时间
	date -set  "2013-12-24 00:01"  (年 / 月 / 日 时: 分【: 秒】) 
	date 有几种时间格式可接受，这样也可以设置时间：
	date 012501012009.30     (月日时分年. 秒 )
	date +%s 转换时间戳
```
## hwclock / clock 
clock和hwclock用法相近，只不过clock命 令除了支持x86硬件体系外，还支持Alpha硬件体系。由于目前绝大多数用户使用x86硬件体系，所以可以视这两个命令为一个命令来学习。
```bash
	查看硬件时间可以是用 
	hwclock
	hwclock --show
	hwclock -r
	clock --show
	设置硬件时间
	hwclock --set --date="07/07/06 10:19" (月/日/年 时:分:秒)
	clock --set --date="07/07/06 10:19" (月/日/年 时:分:秒)
    - 运行 hwlock —— sysohc 将当前软件的 UTC 时间写入硬件时钟。
	hwclock --show   /date
hwclock --localtime
hwclock --utc 
hwclock --show --utc
要设置特定时间，请运行：
hwclock --set --date "2023-02-21 10:16:54"

```
按照前面的说法，重新启动系统，硬件时间会读取系统时间，实现同步，但是在不重新启动的时候，需要用hwclock或clock命令实现同步。
	
	硬件时钟与系统时钟同步：

```bash
	hwclock --hctosys(hc代表硬件时间，sys代表系统时间)
	注意:-s和-hctosys选项都是一样的。-hctosys代表“硬件时钟到系统”，它将时间从硬件时钟复制到系统时钟。
	clock --hctosys
```
	系统时钟和硬件时钟同步：
```bash
	hwclock --systohc
	注意:-w和-systohc选项都执行相同的操作。systohc代表“系统到硬件时钟”，它将时间从系统复制到硬件时钟。
	clock --systohc
```


## 自动设置 Time zone 时区

除了手动设置时区
	检查为系统定义的当前区域: timedatectl status  
	列出可用时区: timedatectl list-timezones  
	设置时区: timedatectl set-timezone Zone/SubZone  
:::tip
这将创建一个/etc/localtime 符号链接，指向/usr/share/zoneinfo/下的 zoneinfo 文件。如果你选择手动创建链接(例如在 chroot 中 timedatectl 不工作) ，请记住它必须是一个符号链接，如 [localtime (5)描述](https://man.archlinux.org/man/localtime.5#DESCRIPTION):
:::
```
# ln -sf /usr/share/zoneinfo/Zone/SubZone /etc/localtime
```
:::tip
提示: 还可以通过 tzselect 交互式地选择时区。
:::

### 基于地理定位的设置
要根据 IP 地址位置自动设置时区，可以使用地理定位 API 检索时区，例如 curl https://ipapi.co/timezone ，并将输出传递给 timedatectl set-timezone 进行自动设置。一些提供免费或部分免费服务的地理知识产权应用程式介面如下:
[Abstract IP geolocation API](https://www.abstractapi.com/ip-geolocation-api)  
[FreegeoIP](https://freegeoip.app/) 
[IP-api](https://ip-api.com/)  
[IPAPI](https://ipapi.co/)  
[Ipdata](https://ipdata.co/)  
[Ipstack](https://ipstack.com/)  
[TimezoneApi](https://timezoneapi.io/)  
### 每次 NetworkManager 连接到网络时更新时区
创建 NetworkManager 调度程序脚本:

```bash title="/etc/NetworkManager/dispatcher.d/09-timezone"
#!/bin/sh
case "$2" in
    up)
        timedatectl set-timezone "$(curl --fail https://ipapi.co/timezone)"
    ;;
esac
```
:::info

提示: 使用 `connectivity-change` 而不是 `up` 可以防止在连接 VPN 时发生时区更改。
:::

### 每个用户/会话或临时设置

如果你想让应用程序“看到”与系统时区不同的时区，设置 TZ 环境变量，例如:
```bash
$ date && export TZ=":/usr/share/zoneinfo/Asia/Shanghai" && date
Tue Feb 21 21:24:25 CST 2023
Tue Feb 21 21:24:25 CST 2023
```


