---
title: 时间同步
---
为了避免主机时间因为长期运作下所导致的时间偏差，进行时间同步 (synchronize) 是非常必要的。 Network Time Protocol (NTP 网络时间协议) 是一种通过分组交换、可变延迟数据网络来同步计算机系统时钟的协议。
 
本节介绍了以下 NTP 时间同步方案: 
- ntpdate + crontab
- ntpd
- chrony
- systemd-timesyncd

:::info
常见的 NTP 时间服务器:
1. [ntp.aliyun.com](https://help.aliyun.com/document_detail/92704.html)  
  阿里云 NTP 服务器，提供了阿里云内网和公网 NTP 服务器，用于同步各网络中 ECS 实例的本地时间。
1. [pool.ntp.org](https://www.pool.ntp.org/zh/use.html) 
  一个超大的 NTP 服务集群, 为上百万的客户端提供可靠易用的网络时间协议(NTP)服务的项目
:::tip

:::tip
在开始前请确保你已经设置了正确的时区和防火墙
- Time Zone
```bash
sudo timedatectl set-timezone "Asia/Shanghai" 
# sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

```
- Firewall
```bash title="防火墙"
# 打开防火墙端口以允许传入的 NTP 请求：
firewall-cmd --permanent --add-service=ntp

# UDP 端口号 123 必须在防火墙中打开以允许客户端访问：
firewall-cmd --permanent --zone=public --add-port=123/udp
# UDP 端口 323 必须在防火墙中打开才能从远程系统连接：
firewall-cmd --permanent --zone=public --add-port=323/udp

firewall-cmd --reload

```
:::
:::caution
ESX VM 上的 VMware Tools 软件负责同步时间，因此不要在带有 VMware Tools 的 VM 上使用 ntpd。改为在主机上设置 NTPD，让 VMware Tools 完成剩下的工作。
:::
## ntpadte
ntpdate 它允许本地时间与 Internet 上的时间服务器进行一次性的时间同步。它通常配合 crontab 定时任务来对时间进行持续校准。
### 手动同步
```bash title="以 ntp.aliyun.com 时间服务器为例"
sudo ntpdate ntp.aliyun.com 
22 Feb 21:46:44 ntpdate[3645]: step time server 84.16.73.33 offset 85807.801323 sec
```
:::tip
ntpdate 在端口 123 上运行  
如果 ntpdate 启动失败并出现错误 `the NTP socket is in use, exiting` 请做如下排查
- 请确保你的防火墙允许此端口
- 如果安装并运行了 ntpd/chrony 服务，将会占用 ntpdate 工作所需的 123 udp 端口。若不想停止服务则可以使用 `ntpdate -u <ntp-server-addres>` 。
:::

### ntpdate + crontab 定时同步
```bash
sudo ntpdate ntp.aliyun.com 
sudo sh -c 'echo "0 */1 * * * /usr/sbin/ntpdate ntp.aliyun.com  >/dev/null 2>&1" >> /var/spool/cron/root'
timedatectl status && crontab -l
# sudo hwclock -w              # 将系统时间写入 RTC 硬件时钟
```
### 添加开机启动
可以在其他服务启动前同步好时间
```bash
sudo bash -c 'cat << EOF >> /etc/rc.local
/usr/sbin/ntpdate ntp.aliyun.com 
EOF'
sudo chmod +x /etc/rc.d/rc.local
```

:::info
- 由于 `ntpdate` 会直接修改时间，所以会造成时间的跳跃。当 `ntpdate` 发现你的时间快了，则会回调到之前的时间点，导致你的系统经历两个相同的时刻，对某些应用而言，这是致命的。因此，请放弃使用 `ntpdate` 来校时。且 `ntpdate` 无法修正时钟振荡频率，治标不治本。
- 唯一一个可以令时间发生跳跃的时间点，是计算机刚刚启动，但还没有启动很多服务的那个时候。其余的时候，理想的做法是使用 `ntpd/Chrony` 来校准时钟，而不是调整计算机时钟上的时间。
- `ntpd` 和`Chrony` 的修正是连续的，通过减慢时钟或者加快时钟的方式连续的修正，会获得平滑的时间校正而不会造成时钟跳跃。并且可以在修正时间的同时，把 BIOS 计时器的振荡频率偏差记录下来。这样即使网络有问题，本机仍然能维持一个相当精确的走时。
:::
## ntpd

### 安装配置
- HostA Server 节点，对接外部 NTP Server: ntp.aliyun.com
- HostB Client 节点，对接主节点: HostA


```bash title="HostA Server 节点"
sudo yum install -y ntp
sudo sed -i -e 's/^server/#&/' \
            -e '1a server ntp.aliyun.com iburst' \
            -e '1a server 127.127.1.0' \
            -e '1a fudge 127.127.1.0 stratum 10' \
            /etc/ntp.conf
sudo systemctl enable --now ntpd
```

<!-- 如果这台作为内网时钟源服务端的话，做如下设置
#ntp实现同步本机时钟
server 127.127.1.0  #local clock，如果是时间服务器请修改为对应IP        
fudge 127.127.1.0  stratum 10
如下按需修改：
restrict 10.0.0.0 mask 255.255.255.0      #允许10.0.0.0 网段中的服务器访问本ntp服务器进行时间同步（按自己内网来）
restrict 10.0.0.16                #允许单个IP地址访问本ntp服务器（按ip来）
restrict 192.168.111.0 mask 255.255.255.0 nomodify notrap              #允许内网其他机器同步时间，如果不添加该约束默认允许所有IP访问本机同步服务
其它配置不用进行修改，保存退出配置文件

client 添加 server IP（这里IP是上边服务端的也就是时钟源的 ip） iburst -->


```bash title="HostB Client 节点"
sudo yum install -y ntp
sudo sed -i -e 's/^server/#&/' \
            -e '1a HostA iburst' \
            /etc/ntp.conf
sudo systemctl enable --now ntpd
```
然后使用 `ntpq -p` 命令观察是否同步
```bash
[vagrant@HostA ~]$ ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 LOCAL(0)        .LOCL.          10 l  202   64   30    0.000    0.000   0.000
*203.107.6.88    100.107.25.114   2 u   60   64   17   18.521  6600087   1.382
# `*` 代表当前同步的源
```
:::caution
如果本机与上源时间相差太大, ntpd 可能不会运行。  
- 可在启动 ntpd 前使用 `sudo ntpdate ntp.aliyun.com` 或 `sudo ntpd -qg` 从上源取得时间初值。(-g 允许第一次调整很大, -q 设置时间后退出进程)  
- 在此处 `cat /etc/sysconfig/ntpd` 加入 `OPTIONS="-g"` 也是有效的
  ```bash
  # Command line options for ntpd
  OPTIONS="-g"
  ```
:::
### 配置解析

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
<TabItem value="默认配置">

```bash title='cat /etc/ntp.conf |grep -v -E "^#|^$"'
driftfile /var/lib/ntp/drift
restrict default nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict ::1
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor
```

</TabItem>
<TabItem value="配置举例">

```bash
# 使用 Local Time
server 127.127.1.0                      # NTP 主服务器可与自身的系统时钟同步
fudge 127.127.1.0 stratum 10            # 指定阶层编号为10，降低其优先级
restrict 127.0.0.1                      # 不对 127.0.0.1  做任何限制
restrict ::1                            # 不对 ::1 做任何限制

# 指定上层服务器
server ntp.aliyun.com iburst prefer # perfer 表示优先级最高(非必要添加)

logfile /var/log/ntp.log          # 指定日志文件位置
broadcastdelay 0.009              # 广播延迟
# 默认配置
restrict default kod nomodify notrap noquery nopeer # 设置默认策略为允许任何主机进行时间同步,可以进一步缩小范围 restrict 192.168.56.0 mask 255.255.255.0 kod nomodify notrap noquery nopeer 
driftfile /var/lib/ntp/drift      # 为了解决更新时间封包的传送延迟动作，使用 driftfile 来规定我们的主机在与 Time Server 沟通时所花费的时间
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor
```
</TabItem>
</Tabs>

1. 上层主机地址
   - 格式: server [IP|HOST Name] [prefer]
   - 参数后面加上 perfer 表示最大优先级
   - 建议您列出至少两个可以进行同步的远程服务器,将本机也加到同步列表中。如果网络出现问题或者远程 NTP 服务器出现故障，则使用 127.0.0.1 ,直到它可以再次开始与远程服务器进行同步。
   - 要缩短初始同步所用的时间，请将 `iburst` 添加到 `server` 命令的末尾
2. 权限设定
   - 格式: restrict address [mask mask] option
   - 一些DDoS攻击可以利用NTP服务器将流量放大,为了防止你的服务器被卷入这种攻击，建议你将你的服务器配置为只响应你信任的特定服务器的NTP请求。  
     ntpq和ntpdc查询可用于放大攻击（详见CVE-2013-5211），不要在可公开访问的系统上删除限制默认命令中的noquery选项。
   - 其中地址和掩码指定要对其应用限制的 IP 地址，也可以是 default ，default 就类似 0.0.0.0。
   - restrict -6 表示 IPV6 地址的权限设置。
   - 或者省略掩码和子网掩码，指定一个单独的IP地址。
   - 更多 option 选项可以参考 [redhat_ch-configuring_ntp_using_ntpd](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_ntpd)  
    如果 option 完全没有设定，那就表示该 IP (或网域)“没有任何限制”
### 拓展文档:
- https://docs.ntpsec.org/latest/
- https://access.redhat.com/solutions/393663
- https://serverfault.com/questions/957302/securing-hardening-ntp-client-on-linux-servers-config-file
- https://unix.stackexchange.com/questions/677523/ntp-server-reachable-but-never-select-set-the-time


## chrony
监听端口： 323/udp，123/udp（chrony并且兼容ntpd监听在udp123端口上，自己则监听在udp的323端口上。）

`Chrony` 有两个核心组件：一个是 `chronyd` 守护进程，主要用于调整内核中运行的系统时间和时间服务器同步。它确定计算机增减时间的比率，并对此进行调整补偿。另一个是 `chronyc`，它提供一个用户界面，用于监控性能并进行多样化的配置。`chronyc` 可以在 `chronyd` 实例控制的计算机上工作，也可以在一台不同的远程计算机上工作。

- 端口 `123/udp` 为标准的 `NTP` 监听端口，如果要对外提供 `NTP Server` 功能，必须开启防火墙和监听地址为外部可访问地址。如需修改，你可以通过配置 `port` 参数来修改。
- 端口 `323/udp` 为默认的管理端口。如需修改，你可以通过配置 `cmdport` 参数来修改。


如果在chrony配置文件中指定了ntp服务器的地址，那么chrony就是一台客户端，会去同步ntp服务器的时间，如果在chrony配置了允许某些客户端来向自己同步时间，则chrony也充当了一台服务器，chrony即可同时充当客户端和服务端。

chrony 官网: https://chrony.tuxfamily.org
chrony 官方文档: https://chrony.tuxfamily.org/documentation.html
chrony-faq: https://chrony.tuxfamily.org/faq.html
https://chrony.tuxfamily.org/faq.html  
https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_the_chrony_suite  
https://wiki.archlinux.org/title/Chrony  
https://www.ibm.com/docs/en/db2/11.5?topic=suntp-setting-up-chrony-as-network-time-protocol-server-client-by-using-chronyd-linux  
https://cloud.tencent.com/developer/article/1546322  



### 安装配置

**集群采用Chrony对接外部NTP Server配置** 建议主节点对接外部NTP Server，从节点对接主节点。
- HostA Server 节点对接外部NTP Server: ntp.aliyun.com
- HostB Client 节点对接主节点: HostA

:::caution
先确保停止所有节点的 NTPD 服务
```bash
sudo systemctl disable --now ntpd
```
:::

```bash title="HostA Server 节点"
sudo yum install -y chrony

sudo sed -i -e 's/^server/#&/' \
            -e '1a server ntp.aliyun.com iburst minpoll 4 maxpoll 4' \
            -e '1a server 127.127.1.0' \
            -e '1a local stratum 10' \
            -e '1a allow all' \            
            /etc/chrony.conf
sudo systemctl enable --now chronyd
```

<!-- 配置： vi /etc/chrony.conf
先注释掉网络时钟源，再做如下配置
server 127.0.0.1 iburst        #本地作为时钟源
local stratum 10           #允许本地同步
allow        #允许所有连接
开机启动：systemctl enable chronyd
启动服务：systemctl start chronyd
查看状态：systemctl status chronyd
查看同步：chronyc sources -v     #带星号*为同步成功


或者： timedatectl 命令，NPT synchronized 为yes就是同步完成

client:
然后客户端也是以这台服务端的作为时钟源进行设置
vi /etc/chrony.conf
server  ip（上一台服务端的ip）  iburst
allow    #允许所有 -->

1.  从节点修改Chrony.conf配置文件
```bash title="HostB Client 节点"
sudo sed -i -e 's/^server/#&/' \
            -e '1a server HostA iburst minpoll 4 maxpoll 4' \
            /etc/chrony.conf
```


### 基本命令

一种是交互式模式，一种是命令行模式。输入chronyc回车就进入交互式模式

```bash
# 查看时间同步源服务器的信息
chronyc sources -v # 这里需要注意的是第二个参数，`*` 代表当前同步的源，`-` 代表通过组合算法计算后排除的源。

# 查看时间同步源状态
 chronyc sourcestats -v

# 查看时间同步源在线/离线
chronyc activity

# 在客户端报告已访问到服务器
chronyc clients 

# 检查 NTP 访问是否对特定主机可用
chronyc accheck

# 手动添加一台新的 NTP 服务器
chronyc add server

# 手动移除 NTP 服务器或对等服务器
chronyc delete

# 在客户端报告已访问到服务器
chronyc clients
# 手动设置守护进程时间
chronyc settime

# 校准时间服务器，显示系统时间信息
chronyc tracking
```

### 参数解释
<Tabs>
<TabItem value="默认配置">
```bash title="cat /etc/chrony.conf  |grep -v -E "^#|^$""
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
```
</TabItem>
<TabItem value="配置举例">
```bash
 cat /etc/chrony.conf 
server 192.168.133.101 trust  #可用于时钟服务器
local stratum 10  #即使server指令中时间服务器不可用，也允许将本地时间作为标准时间授时给其它客户端
logdir /var/log/magtools/
driftfile /var/lib/chrony/drift  #根据实际时间计算出计算机增减时间的比率，将它记录到一个文件中，会在重启后为系统时钟作出补偿
makestep 1.0 3  #通常chronyd将根据需求通过减慢或加速时钟，使得系统逐步纠正所有时间偏差。在某些特定情况下，系统时钟可能会漂移过快，导致该调整过程消耗很长的时间来纠正系统时钟。该指令强制chronyd在调整期大于某个域值时调整系统时钟
cmdport 0
rtcsync  #启用内核模式，系统时间每11分钟会拷贝到实时时钟（RTC）
allow 0.0.0.0/0  #指定一台主机、子网，或者网络以允许或拒绝访问本服务器
```
</TabItem>
</Tabs>

```bash

server ntp1.aliyun.com 　　　　    # server 指定上层时钟服务器
server ntp.ntsc.ac.cn prefer 　　　# prefer 最高优先级、 iburst 加快第一次时的同步速度,前四次 NTP 请求，会发送一个八个数据包，包间隔通常为2秒,而不是以 minpoll x 指定的最小间隔，可加快初始同步速度。
# 默认的轮询间隔为minpoll 6 代表 64s,maxpoll 9 代表 512s。
# 如果修改默认设定的话，为了保持时间精度，推荐设定比默认的值更小的值。

通过修改/etc/chrony.conf文件修改轮询间隔，如果修改默认设定的话，为了保持时间精度，推荐设定比默认的值更小的值。
allow 192.168.0.0/24   # allow/deny NETADD/NETMASK/all 允许/拒绝客户端来同步,allow 0.0.0.0/0代表允许所以任意设备
rtcsync #RTC 时间同步,系统时间每11分钟会拷贝到实时时钟（RTC）
local stratum 10 # 远程 server 不可用时，允许将本地时间作为标准时间授时给其它客户端，层级为 10
driftfile /var/lib/chrony/drift # 记录系统时钟获得/丢失时间的速率，根据实际时间计算出计算机增减时间的比率，将它记录到至drift文件中，会在重启后为系统时钟作出补偿
# makestep # 根据需要通过加速或减慢时钟来逐渐校正任何时间偏移。
makestep 10 3 # 如果系统时钟的偏移量大于10秒，则允许在前三次更新中直接调整系统时钟,通常chronyd将根据需求通过减慢或加速时钟，使得系统逐步纠正所有时间偏差。当时间差过大时,或系统时间漂移过快时，会导致该调整过程消耗很长的时间来纠正系统时钟。该指令会像ntpdate那样直接调整时钟。
keyfile /etc/chrony.keys # 指定包含NTP验证密钥的文件
logdir /var/log/chrony 指定存放日志文件的目录
# stratumweight # 该参数用于设置当 chronyd 从可用源中选择同步源时，每个层应该添加多少距离到同步距离。默认情况下设置为 0，让 chronyd 在选择源时忽略源的层级。
stratumweight 0.05
noclientlog # 禁用客户端访问的日志记录
logchange 0.5 # 如果时钟调整大于0.5秒，则向系统日志发送消息
# cmdallow/cmddeny NETADD/NETMASK/all 可以指定哪台主机可以通过chronyd使用控制命令
cmdallow all
bindcmdaddress 127.0.0.1 #命令管理接口监听的地址，用于接收由chronyc执行的命令
bindcmdaddress ::1

```


## systemd-timesyncd
另外，关于 systemd-timesyncd 服务的几句话，它在带有 systemd 的系统上充当简单的 sntp 客户端，不像 chrony 和 ntp，后者也可以作为时间服务器。

注意：如果您的系统没有chrony/ntp，则运行set-ntp子命令尝试激活 timesyncd 组件时遇到错误。

```bash
# timedatectl set-ntp true
Failed to set ntp: NTP not supported
```


## 同步硬件时钟
```bash
1 0 * * *  /usr/sbin/hwclock --systohc
```
ntpd https://www.ibm.com/support/pages/synchronizing-hardware-clock-system-time-when-using-ntp
chrony  rtcsync  RTC将会每隔11分钟更新real-time clock(硬件时钟)，推荐设定。




## 翻译

参考:https://www.thegeekdiary.com/centos-rhel-7-chrony-vs-ntp-differences-between-ntpd-and-chronyd/

Chosing between Chrony and NTP
– In RHEL 7 ntpd is replaced by chronyd as the default network time protocol daemon.
– Basic configuration for synchronize time and date is stored in the file /etc/chrony.conf.
– ntpd is still included in yum repository for customers who need to run an NTP service.
– Chrony is a different implementation of the network time protocol (NTP) than the network time protocol daemon (ntpd) that is able to synchronize the system clock faster and with better accuracy than ntpd.
Benefits of Chrony include:

1. Faster synchronization requiring only minutes instead of hours to minimize the time and frequency error, which is useful on desktops or systems not running 24 hours a day.
2. Better response to rapid changes in the clock frequency, which is useful for virtual machines that have unstable clocks or for power-saving technologies that don’t keep the clock frequency constant.
3. After the initial synchronization, it never steps the clock so as not to affect applications needing system time to be monotonic.
4. Better stability when dealing with temporary asymmetric delays, for example when the link is saturated by a large download.
5. Periodic polling of servers is not required, so systems with intermittent network connections can still quickly synchronize clocks.

When to use chrony
Chrony would be considered a best match for the systems which are frequently suspended or otherwise intermittently disconnected from a network (mobile and virtual servers etc).

When to use NTP
The NTP daemon (ntpd) should be considered for systems which are normally kept permanently on. Systems which are required to use broadcast or multicast IP, or to perform authentication of packets with the Autokey protocol, should consider using ntpd.







---
 chronyc -a makestep





1. `Chrony` 可以更快的同步只需要几分钟而不是几小时，从而最大程度减少了时间和频率误差，对于并非全天 24 小时运行的虚拟计算机而言非常有用，能够更好地响应时钟频率的快速变化，对于具备不稳定时钟的虚拟机或导致时钟频率发生变化的节能技术而言非常有用，而`ntpd`在时差较大时候会禁止同步
2. `Chrony` 通过 Internet 同步的两台机器之间的典型精度在几毫秒之内，在LAN上，精度通常为几十微秒。利用硬件时间戳或硬件参考时钟，可实现亚微秒的精度。  
   `NTP`精度在局域网内可达 0.1ms，在互联网上绝大多数的地方精度可以达到 1-50ms。
3. `Chrony` 无需对服务器进行定期轮询，因此具备间歇性网络连接的系统仍然可以快速同步时
4. [systemd-timesyncd](https://unix.stackexchange.com/questions/504381/chrony-vs-systemd-timesyncd-what-are-the-differences-and-use-cases-as-ntp-cli) 它实现了一个 SNTP 客户端




