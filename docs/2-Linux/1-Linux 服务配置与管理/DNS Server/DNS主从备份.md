---
title: DNS主从备份
---
参考文档 https://www.redhat.com/sysadmin/dns-configuration-introduction

Domain Name System (DNS) 域名系统 用于将主机名解析 为IP地址  
在本文中，您将学习 DNS 的基础知识，从 DNS 如何获取 IP 地址和主机名，到正向和反向查找区域的概念。它还将向您展示如何安装和配置 DNS，定义和编辑区域文件，并验证 DNS 是否可以通过命令帮助解析到正确的地址。如果您刚接触 DNS，本文将帮助您使用基本配置在系统上使用它。

## 域名系统是如何工作的

当客户端从命名服务器请求信息时，它通常连接到端口53，然后命名服务器解析所请求的名称。

![1677224846192](image/DNS主从备份/1677224846192.png)
(Ashish Bharadwaj, CC BY-SA 4.0)
Sending a request from the DNS client to the DNS server is called a 
从 DNS 客户机向 DNS 服务器发送请求称为 lookup request.查找请求。
Getting a response from the DNS server to the DNS client is called a lookup response.
从 DNS 服务器到 DNS 客户端的响应称为查找响应。
The system on which the DNS service is configured is called a DNS server.
配置 DNS 服务的系统称为 DNS 服务器。
The system that accesses the DNS server is called a DNS client.
访问 DNS 服务器的系统称为 DNS 客户端。



## Where does DNS get IP addresses? DNS 从哪里获得 IP 地址？


您可能想知道 DNS 如何获得相应主机名或域名的 IP。DNS 如何在不同的 IP 地址之间进行搜索并正确地关联您的域名？谁存储域名和 IP 地址之间的映射？  
DNS 工作流说明了如何在 DNS 中进行通信以及如何解析地址。
![1677225611581](image/DNS主从备份/1677225611581.png)
(Ashish Bharadwaj, CC BY-SA 4.0)
When the client searches for the domain www.example.com, the request will initially go to the internet service provider's (ISP) resolver. It will respond to the user's request to resolve a domain name.
当客户机搜索域 www.example.com 时，请求最初将转到 Internet 服务提供商(ISP)的解析器。它将响应用户解析域名的请求。
If the IP address is not found on the resolver, the request is forwarded to a root DNS server and later to the top-level domain (TLD) servers.
如果在解析器上没有找到 IP 地址，请求就会被转发到根 DNS 服务器，然后再转发到顶级域(tLD)服务器。
TLD servers store information for top-level domains, such as .com or .net.
TLD 服务器存储顶级域(如.com 或.net)的信息。
Requests are forwarded to the nameservers, which know detailed information about domains and IP addresses.
请求被转发到名称服务器，这些服务器知道域和 IP 地址的详细信息。
Nameservers respond to the ISP's resolver, and then the resolver responds to the client with the requested IP.
命名服务器响应 ISP 的解析器，然后解析器用请求的 IP 响应客户机。
When the resolver doesn't know the IP, it stores the IP and its domain in a cache to service future queries.
当解析器不知道 IP 时，它将 IP 及其域存储在缓存中，以便为将来的查询提供服务。

## Forward and reverse lookups 正向和反向查找

正向查找区域使用域名搜索 IP 地址，而反向查找区域使用 IP 地址搜索域名。

![1677225645788](image/DNS主从备份/1677225645788.png)
(Ashish Bharadwaj, CC BY-SA 4.0)



## Install and configure DNS 安装和配置 DNS
BIND 是一个名称服务器服务，负责在基于 Linux 的 DNS 服务器上执行域名到 IP 的转换。
```bash
[root@servera ~] # yum install bind
```
BIND 包提供命名服务。它从/etc/name 和/etc/named.conf 文件中读取配置。安装此包后，您可以开始配置 DNS。

配置/etc/named.conf 文件
首先，在选项字段中添加或编辑这两个值。一个是 DNS 服务器地址，另一个是对任意。

```bash
[root@servera ~] # vim /etc/named.conf
listen-on port 53 { 127.0.0.1; 192.168.25.132; };
allow-query { localhost; any; };
```

下面是上面文件中的值:

192.168.25.132 – DNS server address
192.168.25.132-DNS 服务器地址
any – matches every IP address
任何-匹配每个 IP 地址

## Define the forward and reverse zones 定义正向和反向区域


在/etc/named.conf 或/etc/named.rfc1912.zone 中定义正向和反向区域(您可以在这两个文件中的任何一个中定义区域)。在本例中，我将区域定义细节附加到/etc/named.rfc1912.zone 文件。

```bash
[root@servera ~] # vim /etc/named.rfc1912.zones
  zone "example.com" IN { type master;
  file "example.forward.zone";
  allow-update { none; };
};

  zone "25.168.192.in-addr.arpa" IN { 
   type master;
   file "example.reverse.zone";
   allow-update { none; };
};
```

## Create forward and reverse zone files 创建正向和反向区域文件

您还需要在/var/命名目录中创建正向和反向区域文件。

注意: 默认情况下，named.conf 文件包含用于检查区域文件的/var/name 目录。在安装 BIND 包期间，将创建名为 ed.localhost 和 named.loop back 的示例区域文件。

[root@servera ~] # vim /var/named/example.forward.zone
![1677225776740](image/DNS主从备份/1677225776740.png)
[root@servera ~] # vim /var/named/example.reverse.zone
![1677225786271](image/DNS主从备份/1677225786271.png)

## Add the nameserver IP to /etc/resolv.conf  将名称服务器 IP 添加到/etc/Resolv.conf
首先，必须禁用 NetworkManager 的 DNS 处理，因为它使用活动连接配置文件中的 DNS 设置动态更新/etc/Resolv.conf 文件。若要禁用此选项并允许手动编辑/etc/Resolv.conf，必须创建一个文件(例如，90-dns-none。Conf) ，作为/etc/NetworkManager/conf/目录中的根目录，该目录包含以下内容:
```
[main]
dns=none
```

保存文件并重新加载(重新启动) NetworkManager。
systemctl reload NetworkManager


重新加载 NetworkManager 后，它不会更新/etc/Resolv.conf。现在，您可以手动将名称服务器的 IP 地址添加到/etc/Resolv.conf 文件中。

```bash
[root@servera ~] # vim /etc/resolv.conf
# Generated by NetworkManager 
search localdomain example.com 
nameserver 192.168.25.132
```


[做好万一出现问题的准备。阅读 [DNS 故障排除简介](https://www.redhat.com/sysadmin/intro-dns-troubleshooting)。]


## Start/restart and enable the named service
启动/重新启动并启用命名的服务

如果命名服务未运行或禁用，则启动并启用它。如果它已经处于活动状态(正在运行)并且您进行了所有这些配置，则需要重新启动服务以进行更改。

```bash
[root@servera ~] # systemctl status named.service

[root@servera ~] # systemctl start named.service

[root@servera ~] # systemctl enable named.service

[root@servera ~] # systemctl restart named.service
```

## Verify the DNS name resolution
验证 DNS 名称解析


您已经安装了 BIND 包，配置了命名文件，创建了查找区域，并重新启动了服务以使配置生效。现在使用 nslookup 和 dig 命令检查 DNS 是否正常工作，并验证是否得到了预期的结果。

- nslookup is a program to query internet domain name servers.
- Nslookup 是一个查询互联网域名服务器的程序。
- dig is a tool for interrogating DNS servers. It performs DNS lookups and displays the answers that are returned from the nameserver.
- Dig 是一个查询 DNS 服务器的工具。它执行 DNS 查找并显示从命名服务器返回的答案。


## Query with nslookup
使用 nslookup 查询

```bash
[root@servera ~] # nslookup servera.example.com
  Server: 192.168.25.132
  Address: 192.168.25.132#53
  Name: servera.example.com
  Address: 192.168.25.132

[root@servera ~] # nslookup 192.168.25.132 
   132.25.168.192.in-addr.arpa name = servera.example.com.
```

## Query with dig
用挖的方式提问
Here is a forward lookup, where DNS responds with 192.168.11.132 as an IP for servera.example.com:

下面是一个正向查找，其中 DNS 响应为192.168.11.132作为 servera.example.com 的 IP:
```bash
[root@servera ~] # dig servera.example.com
   ...output truncated...

;; ANSWER SECTION:
servera.example.com. 86400 IN A 192.168.25.132


;; AUTHORITY SECTION:
example.com. 86400 IN NS servera.example.com.

...output truncated...

```
这个例子显示了一个反向查找，其中 DNS 服务器以 servera.example.com 作为192.168.25.132的域名进行响应:


```bash
[root@servera ~] # dig -x 192.168.25.132
  ...output truncated...

;; ANSWER SECTION:
132.25.168.192.in-addr.arpa. 86400 IN PTR servera.example.com.

;; AUTHORITY SECTION:
25.168.192.in-addr.arpa. 86400 IN NS servera.example.com.

;; ADDITIONAL SECTION:
servera.example.com. 86400 IN A 192.168.25.132

...output truncated...
```


[ Network getting out of control? Check out [Network automation for everyone](https://www.redhat.com/en/resources/network-automation-for-everyone-ansible-automation-platform-ebook?intcmp=701f20000012ngPAAQ), a free book from Red Hat. ]


[网络失控? 请查看每个人的网络自动化，一本来自红帽的免费书。]


## Wrap up
收工

在本文中，您了解了什么是 DNS 以及它是如何工作的。此外，您现在知道什么是正向和反向查找区域，以及它们是如何工作的。您还了解了如何安装 BIND 包，该包负责在系统上设置 DNS 并配置命名文件和查找区域。最后，您学习了两个命令 nslookup 和 dig 来查询 DNS 解决方案。



## 安装Bind

```bash
# Master & Slave
yum install -y bind-utils bind bind-devel bind-chroot
```

## 配置文件

options{} 中添加修改如下
- 主节点：
   ``` bash
   vi /etc/named.conf
   	listen-on port 53 { 10.4.7.101; };
   	allow-query     { any; };
   	forwarders      { 8.8.8.8;114.114.114.114; };
   ```
- 从节点：

   ``` bash
   vi /etc/named.conf
   
   	listen-on port 53 { 10.4.7.102; };
   	allow-query     { any; };
   	forwarders      { 8.8.8.8;114.114.114.114; };
   ```


``` bash
cat /etc/named.conf

options {
	listen-on port 53 { 10.4.7.101; };# 设置named监听的端口号、IP地址
	listen-on-v6 port 53 { ::1; };
	directory 	"/var/named";
	dump-file 	"/var/named/data/cache_dump.db";
	statistics-file "/var/named/data/named_stats.txt";
	memstatistics-file "/var/named/data/named_mem_stats.txt";
	recursing-file  "/var/named/data/named.recursing";
	secroots-file   "/var/named/data/named.secroots";
	allow-query     { any; };# 允许DNS查询的客户端地址
    forwarders      { 8.8.8.8;114.114.114.114; };  # 设置上层DNS服务器

	recursion yes;
	
# 可关闭dnssec降低开销：       dnssec-enable no;       dnssec-validation no;
	dnssec-enable yes;
	dnssec-validation yes;

	/* Path to ISC DLV key */
	bindkeys-file "/etc/named.root.key";

	managed-keys-directory "/var/named/dynamic";

	pid-file "/run/named/named.pid";
	session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
	type hint;
	file "named.ca";
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
# 可注释 		# include "/etc/named.root.key";

```
## 区域配置文件

> vi /etc/named.rfc1912.zones 末尾追加

1. 主节点

```bash
# vi /etc/named.rfc1912.zones
# 末尾追加

zone "host.com" IN {
        type master;
        file "host.com.zone";
        masterfile-format text;
        allow-transfer {10.4.7.102;};
        notify yes;
        also-notify {10.4.7.102;};
        allow-update {none;};
};

zone "ops.com" IN {
        type master;
        file "ops.com.zone";
        masterfile-format text;
        allow-transfer {10.4.7.102;};
        notify yes;
        also-notify {10.4.7.102;};
        allow-update {none;};
};

zone "7.4.10.in-addr.arpa" IN {
        type master;
        file "10.4.7-host.com.arpa";
        masterfile-format text;
        allow-transfer {10.4.7.102;};
        notify yes;
        also-notify {10.4.7.102;};
        allow-update {none;};
};
```
2. 从节点
```bash
# vi /etc/named.rfc1912.zones
# 末尾追加
zone "host.com" IN {
        type slave;
        file "slaves/host.com.zone";
        masters { 10.4.7.101; };
        masterfile-format text;
};

zone "ops.com" IN {
        type slave;
        file "slaves/ops.com.zone";
        masters { 10.4.7.101; };
        masterfile-format text;
};
zone "7.4.10.in-addr.arpa" IN {
        type slave;
        file "slaves/10.4.7-host.com.arpa";
        masters { 10.4.7.101; };
        masterfile-format text;
};
```
3. 单节点配置（如果你不想配置主从同步的话）

``` bash
zone "host.com" IN {
        type master;
        file "host.com.zone";
        allow-update { 10.4.7.101; }; //允许动态更新的客户端地址
};

zone "ops.com" IN {
        type master;
        file "ops.com.zone";
        allow-update { 10.4.7.101; };
};
```

## 区域数据文件

> 只需配置主节点，从节点待服务启动后会自动同步

+ 创建配置文件

   ```bash
   cp -a named.localhost 10.4.7-host.com.arpa
   cp -a named.localhost host.com.zone
   cp -a named.localhost ops.com.zone
   ```
   
+ 注意用户和权限
   ``` bash
   root@host7-101[21:17:14]:~$ ll /var/named/
   -rw-r----- 1 root  named  273 May 24 21:03 host.com.zone
   -rw-r----- 1 root  named  495 May 24 21:06 ops.com.zone
   -rw-r----- 1 root  named  364 May 25 05:28 10.4.7-host.com.arpa
   ```
+ 如果用户组不合法可能配置文件无法被reload服务启动会失败，权限不合法则可能无法完成主从同步、修改权限如下
   ```bash
   chgrp named /var/named/abcdocker.com.zone 
   chmod 640 /var/named/abcdocker.com.zone
   ```
1. host.com.zone 

   ```bash
   # vi host.com.zone 
   $TTL 1D
   @	IN SOA	ns.host.com.  email.outlook.com. (
   					2021052566	; serial
   					1D	; refresh
   					1H	; retry
   					1W	; expire
   					3H )	; minimum
   		NS		ns1.host.com.
   		NS		ns2.host.com.
   ns1	A	10.4.7.101
   ns2	A	10.4.7.102
   host7-101       A       10.4.7.101
   host7-102       A       10.4.7.102
   host7-103       A       10.4.7.103
   
   ```
2. ops.com.zone

   ```bash
   # vi  ops.com.zone
   $TTL 1D
   @       IN SOA  ns.ops.com.  email.outlook.com. (
                                           2021052560       ; serial
                                           1D      ; refresh
                                           1H      ; retry
                                           1W      ; expire
                                           3H )    ; minimum
           NS      ns1.ops.com.
           NS      ns2.ops.com.
   ns1	A	10.4.7.101
   ns2	A	10.4.7.102
   harbor	A	10.4.7.100
   kubernetes A    10.4.7.100
   ```

3. 10.4.7-host.com.arpa (反向解析可不配置)

   ```bash
   # vi 10.4.7-host.com.arpa 
   $TTL 1D
   @	IN SOA	ns.host.com email.outlook.com (
   					2021052560	; serial
   					1D	; refresh
   					1H	; retry
   					1W	; expire
   					3H )	; minimum
   	NS	ns1.host.com.
           NS      ns2.host.com.
   ns1	A	10.4.7.101
   ns2	A	10.4.7.102
   101	PTR	ns1.host.com.
   102	PTR	ns2.host.com.
   101	PTR	host7-101.host.com.
   102	PTR	host7-102.host.com.
   103 PTR	host7-103.host.com.
   ```

##  服务启动&验证

1. 启动服务并加入开机自启

   ```bash
   #  master & slave
   named-checkconf
   systemctl start named
   systemctl enable  named
   ```

2. 验证服务状态

   

   ```bash
   # 将各节点dns修改为10.4.7.101并重启网卡
   cat /etc/resolv.conf
   # Generated by NetworkManager
   search host.com
   nameserver 10.4.7.101
   # 重启网络之后，NetworkManager会自动更新/etc/resolv.conf，search host.com 表示默认会搜索host.com，即ping    host7-101.host.com的域名可以缩写为，ping host7-101 
   
   # 查看
   rpm -qa bind
   netstat -lntup|grep 53
   nslookup
   dig hdss7-22.host.com
   dig -t A hdss7-11.host.com @10.4.7.11 +short
   10.4.7.11
   ```

   若为虚机环境，可在windows宿主机配置如下

   自动跃点是为了优先走此网卡的DNS，可在宿主机用域名测试集群服务。


3. 验证主从同步

   ```
   重启两端服务，主节点启动时会向NS记录发送同步数据
   查看从节点
   root@host7-102[04:26:31]:/var/named/slaves$ pwd
   /var/named/slaves
   root@host7-102[04:26:35]:/var/named/slaves$ ll
   total 12
   -rw-r--r-- 1 named named 502 May 25 03:59 10.4.7-host.com.arpa
   -rw-r--r-- 1 named named 387 May 25 04:01 host.com.zone
   -rw-r--r-- 1 named named 382 May 25 03:59 ops.com.zone
   ```
   

在主节点/var/named/host.com.zone中增加一条A记录，并将 serial 值+1，然后rndc reload
这时message 会提示下图，在从节点查看zone文件是否同步


![image-20210525163114975](https://image-fusice.oss-cn-hangzhou.aliyuncs.com/image/2.%20%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/2021.05.25-17:17:15-D-assets-2.%20%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE-image-20210525163114975.png)

## 常见问题

1. 使用bind 配置DNS，主从无法同步 更新了主服务器的zone文件修改了serial这个值比SLAVE 服务器的值大，
   主服务器上更新区域后，但是从服务器却没有更新，但是删除从服务器上区域文件后，重新启动服务器才行，说明丛服务器是可以更新区域文件过来的，但是为什么却无法实时更新呢？