


本节将介绍 DHCP 的单作用域、超级作用域和 DHCP 中继等场景下的部署方式，并带有实验环境。

import CodeBlock from '@theme/CodeBlock';
import vagrantfile from '!!raw-loader!./DHCP-Playground/Vagrantfile';

:::info 环境准备

在开始前，我们需要准备实验所用到的主机。

<details>
<summary>这里为您准备了 Vagrant 环境，可以一键启动如下环境</summary>

在**新建目录**中创建如下 `Vagrantfile` 文件，然后**在此目录中**执行 `vagrant up` 即可启动练习环境。关于 Vagrant 更多使用方法详见：[Vagrant](/docs/Infrastructure%20as%20Code/Vagrant/)

启动后使用 `vagrant ssh <host_name>` 登录到对环境的各个节点。

此环境已经配置好了各个节点之间的路由，开箱即用。

[**Vagrant 环境配置文件：**](https://github.com/SJFCS/cloudnative.love/tree/main/docs/2-Linux%20Guide/1-Linux%20%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%AE%A1%E7%90%86/DHCP/ISC%20DHCP/DHCP-Playground)

<CodeBlock language="ruby" title="Vagrantfile">{vagrantfile}</CodeBlock>
</details>

![DHCP 拓扑](DHCP拓扑.svg)
:::




```
sudo apt-get update
sudo apt-get install isc-dhcp-server
sudo apt-get install isc-dhcp-relay

/etc/dhcp/dhcpd.conf
/etc/sysconfig/dhcrelay


/usr/share/doc/isc-dhcp-server/ 


sudo nano /etc/default/isc-dhcp-relay

```




## 单作用域

什么是单作用域
单作用域的优缺点

### 如何配置单作用域

静态 IP 地址分配

sudo dhclient eth0

- 手动分配：特定的 IP 地址由管理员预先分配给单个设备。DHCP 仅将 IP 地址传送给设备。
- 自动分配： DHCP 自动为设备永久分配一个 IP 地址，从可用地址池中选择它。
- 动态分配： DHCP 在服务器选择的有限时间内从地址池中分配一个 IP 地址，或者直到客户端告诉 DHCP 服务器它不再需要该地址。
  http://www.tcpipguide.com/free/t_DHCPAddressAssignmentandAllocationMechanisms.htm

编辑 ISC DHCP 服务器的配置文件/etc/dhcp/dhcpd.conf，添加以下内容：

```bash

要配置DHCP服务器以指定NTP服务器，请按照以下步骤操作：
打开DHCP服务器的配置文件，通常在/etc/dhcp/dhcpd.conf。
找到要为其配置NTP服务器的子网段的定义，例如：

subnet 192.168.1.0 netmask 255.255.255.0 {
  range 192.168.1.10 192.168.1.50;
  option routers 192.168.1.1;
}

在子网段定义中添加以下行以指定NTP服务器：

option ntp-servers 192.168.1.100;

其中192.168.1.100是您要使用的NTP服务器的IP地址。如果您有多个NTP服务器，请将它们用逗号分隔。

在子网段定义中添加以下行以指定DNS服务器：

option domain-name-servers 8.8.8.8,8.8.4.4;


## 指定固定IP
以下是一个简单的DHCP服务器配置文件，其中包括一个固定IP地址分配的示例：

# /etc/dhcp/dhcpd.conf

# 设置DHCP服务器的名称和域名
option domain-name example.com;
option domain-name-servers 8.8.8.8;

# 定义DHCP地址池
subnet 192.168.1.0 netmask 255.255.255.0 {
  range 192.168.1.10 192.168.1.100;
  option routers 192.168.1.1;
  option broadcast-address 192.168.1.255;
}

# 配置固定IP地址
host my-computer {
  hardware ethernet 00:11:22:33:44:55;
  fixed-address 192.168.1.5;
}

# 其他配置选项
default-lease-time 600;
max-lease-time 7200;

在上面的示例中，我们为一个名为"my-computer"的设备分配了固定IP地址192.168.1.5。要将此配置文件加载到DHCP服务器中，请使用以下命令：


sudo service dhcpd restart

请注意，实际的配置文件可能因系统和网络环境的不同而有所不同。
##
```

这里配置了一个子网为 192.168.1.0/24 的 DHCP 服务器，分配的 IP 地址范围是 192.168.1.10 - 192.168.1.50，默认网关是 192.168.1.1，DNS 服务器是 Google 的公共 DNS。

其中，option routers 指定了网关地址，option domain-name-servers 指定了 DNS 服务器地址。

### 配置网络接口：

编辑网络接口的配置文件/etc/network/interfaces，将 DHCP 服务器的 IP 地址绑定到网络接口上：

```
auto eth0
iface eth0 inet static
address 192.168.1.1
netmask 255.255.255.0
broadcast 192.168.1.255
```

以上配置表示网络接口 eth0 使用静态 IP 地址 192.168.1.1，并设置子网掩码为 255.255.255.0，广播地址为 192.168.1.255。

### 单作用域、超级作用域和 dhcp 中继

【进阶—超级作用域】

目的：为不同段的网络做 DHCP 功能,使用一块网卡为不同网络进行路由和 dhcp 分配 ip

Centos 6.8 三台 分别为 DHCP Server(route)、Client1、Client2

**实验步骤**

```
1、关闭防火墙、Senlinux、虚拟机的网卡这几步跟第一个实验相同

2、在DHCP服务器上开启子网卡；复制网卡的配置文件即可
在子网卡的配置文件中，不需要删除MAC、UID，因为这是一个子网卡，只需修改一下IP即可
```

开启 DHCP 服务器的路由转发功能并使其生效

```
[root@localhost ~]# sysctl -p
net.ipv4.ip_forward = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
```

3、修改 dhcp 主配置文件

### 多域案例

【高级—DHCP 中继】
DHCP 中继被称为 DHCP Relay；是为了实现不同子网和物理网段之间处理和转发 dhcp 信息
DHCP Relay 是一个网络协议，它可以将 DHCP 请求从一个网络中转到另一个网络上的 DHCP 服务器。在 Linux 上，可以使用 dhcrelay 命令来配置 DHCP Relay。

Centos 6.8 四台 分别为 DHCP Server、DHCP 中继、Client1、Client2

server 192.168.10.0/24
client1 192.168.10.0/24
client2 192.168.20.0/24
Relay&Route 且为网关

安装 dhcp-relay 软件包。在 Ubuntu 上，可以使用以下命令安装它：

```bash
sudo apt-get install dhcp-relay
```

安装 dhcp-relay 软件包。在 CentOS 上，可以使用以下命令安装：

```
sudo yum install dhcp-relay
cat /etc/default/isc-dhcp-relay
```

配置 DHCP

4、配置 DHCP 中继服务器
编辑 /etc/default/dhcp-relay 文件，并指定 DHCP 服务器的 IP 地址和需要中转的网络接口。例如，如果 DHCP 服务器的 IP 地址是 192.168.1.1，需要中转的网络接口是 eth0，则可以将以下行添加到 /etc/default/dhcp-relay 文件中：

```bash
DHCPD_SERVERS=192.168.1.1
INTERFACES=eth0
```

如果要中继多个 DHCP 服务器，可以使用逗号分隔它们的 IP 地址。



3.编辑 /etc/dhcp/dhcrelay.conf 文件，并指定需要中转的 DHCP 子网。例如，如果需要中转的 DHCP 子网是 192.168.2.0/24，则可以将以下行添加到 /etc/dhcp/dhcrelay.conf 文件中：

```bash
relay 192.168.2.0/24
```

```
配置网卡
eth0:192.168.10.20
eth1:100.100.100.20

vim /etc/sysconfig/dhcrelay
将自己的两个网卡接口与DHCP服务器的IP地址标明
```

```bash
# 开启路由转发并使其生效
[root@localhost ~]# vim /etc/sysctl.conf
[root@localhost ~]# sysctl -p
net.ipv4.ip_forward = 1
# 开启中继服务
sudo service isc-dhcp-relay start
sudo systemctl enable --now dhcp-relay
```

完成上述步骤后，DHCP 请求将被转发到指定的 DHCP 服务器上。您可以使用 tcpdump 命令来检查是否已正确配置 DHCP Relay。



## 超级作用域

什么是超级作用域!
超级作用域的优缺点

### 如何配置超级作用域


## DHCP 中继

什么是 DHCP 中继
DHCP 中继的优缺点

### 如何配置 DHCP 中继

