## ssh-to-VM
ssh -p 1031 ops@10.196.96.214
ops@1024

ssh vagrant@qadnode1
ssh vagrant@qadnode2
ssh vagrant@qadnode3
ssh vagrant@qadnode4

## FQDN

sudo bash -c 'cat << EOF >> /etc/hosts
172.30.3.41 qadnode1.local qadnode1
172.30.3.42 qadnode2.local qadnode2
172.30.3.43 qadnode3.local qadnode3
172.30.3.44 qadnode4.local qadnode4
EOF'
cat /etc/hosts


## disk
sudo fdisk /dev/vdb
sudo fdisk /dev/vdc

sudo mkfs.xfs -f /dev/vdb
sudo mkfs.xfs -f /dev/vdc
sudo mkdir -p /mnt/data{01..02} 
#sudo mount /dev/vdb /mnt/data01
#sudo mount /dev/vdc /mnt/data02



#使用UUID比较好
sudo bash -c 'cat << EOF >> /etc/fstab
/dev/vdb        /mnt/data01     xfs     defaults        0 0
/dev/vdc        /mnt/data02     xfs     defaults        0 0
EOF'

sudo mount -a
lsblk -f

## FTP
sudo systemctl --now disable firewalld
setenforce 0
sudo sh -c 'sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config'
## yum repo
略
yum clean all
yum makecache
sudo yum install wget -y

# wget -r -np -nH -R index.html http://repo.bdms.service.163.org/EasyData-V7.0/
# rpm -Uvh http://mirrors.ustc.edu.cn/epel/epel-release-latest-7.noarch.rpm
# yum install epel-release -y
# yum install ansible

# ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.207.137
# ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.207.132
# ssh-keygen -t rsa


## ntp
sudo timedatectl set-timezone "Asia/Shanghai"

sudo yum -y install ntp
edit config
sudo systemctl enable --now ntpd
sudo yum -y install ntpdate

sudo ntpdate 172.30.3.41
timedatectl status
sudo hwclock -w

sudo crontab -e
0 */1 * * * /usr/sbin/ntpdate 172.30.3.41 >/dev/null 2>&1

sudo bash -c 'cat << EOF >> /etc/selinux/config
/usr/sbin/ntpdate 172.30.3.41
EOF'
sudo chmod +x /etc/rc.d/rc.local


## user

cat -n /etc/bashrc | grep -2 'umask'    # 71行是普通用户的更改，默认002；73是超级用户的更改，默认022
cat -n /etc/profile | grep -2 'umask'   # 60行是普通用户的更改，默认002；62是超级用户的更改，默认022

sudo sed -i "s/077/022/g" /etc/login.defs

sudo groupadd easyops
sudo useradd easyops -g easyops -s /bin/bash -d /home/easyops

sudo su - easyops
ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa -q

sudo mkdir -p -m 700 /home/vagrant/.ssh
sudo vi /home/vagrant/.ssh/authorized_keys
sudo chmod 600 .ssh/authorized_keys

sudo bash -c 'cat << EOF >> /etc/sudoers
easyops ALL=(ALL:ALL) NOPASSWD:ALL
EOF'
# 注释掉 Defaults requiretty

## check tty
systemctl get-default
 
#若显示graphical.target则表示图形化界面
#multi-user.target则表示字符界面

#将系统默认启动界面改为字符界面
sudo systemctl set-default multi-user.target
#输入init 3 将图形页面转换为字符页面
init 3


## docker 

### dir
 






---
- service: nginx_ha
  componentList:
    - component: server
      hostList: ["fnode1.local","fnode2.local"]
  configList:
    keepalived_common:
      default_virtual_ip_address: "172.30.1.69"

- service: kerberos
  componentList:
    - component: master
      hostList: ["fnode1.local"]
    - component: slave
      hostList: ["fnode2.local"]
    - component: client
      # 所有机器都安装client
      hostList: ["*"]

- service: ldap
  componentList:
    - component: server
      hostList: ["fnode1.local", "fnode2.local"]
    - component: client
      hostList: ["*"]

- service: easy_ranger
  componentList:
    - component: admin
      hostList: ["fnode1.local","fnode2.local"]

- service: zookeeper
  componentList:
    - component: server
      hostList: ["fnode1.local","fnode2.local", "fnode3.local"]
    - component: client
      # 所有机器都安装client
      hostList: ["*"]

- service: kafka
  componentList:
    - component: manager
      hostList: ["fnode1.local"]
    - component: broker
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]

- service: elasticsearch
  componentList:
    - component: master
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]
    - component: data
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]
  configList:
    data_jvm:
      jvm_heap_size: "2g"
    master_jvm:
      jvm_heap_size: "2g"

- service: ntsdb
  componentList:
    - component: master
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]
    - component: shardserver
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]

- service: neo4j
  componentList:
    - component: server
      hostList: ["fnode1.local", "fnode2.local", "fnode3.local"]

- service: grafana
  componentList:
    - component: server
      hostList: ["fnode2.local"]

- service: redis_sentinel
  componentList:
    - component: server
      hostList: ["fnode1.local"]
    - component: slave
      hostList: ["fnode2.local","fnode3.local"]
    - component: sentinel
      hostList: ["fnode1.local","fnode2.local","fnode3.local"]

- service: ds_agent
  componentList:
    # 部署在所有nodemanager节点
    - component: agent
      hostList: ["fnode2.local","fnode3.local", "fnode4.local"]

- service: logstash
  componentList:
    - component: server
      hostList: ["fnode3.local"]

- service: hdfs
  componentList:
    # zkfc 必须和 namenode 在相同机器
    - component: zkfc
      hostList: ["fnode1.local", "fnode2.local"]
    - component: namenode
      hostList: ["fnode1.local", "fnode2.local"]
    - component: journalnode
      hostList: ["fnode2.local","fnode3.local", "fnode4.local"]
    - component: datanode
      hostList: ["fnode2.local","fnode3.local", "fnode4.local"]
    - component: client
      # 所有机器都安装client
      hostList: ["*"]

- service: yarn
  componentList:
    - component: client
      # 所有机器都安装client
      hostList: ["*"]
    - component: nodemanager
      hostList: ["fnode2.local","fnode3.local", "fnode4.local"]
    - component: resourcemanager
      hostList: ["fnode1.local", "fnode2.local"]
    - component: historyserver
      hostList: ["fnode2.local"]
  configList:
    yarn_site:
      "yarn.scheduler.minimum-allocation-mb": "512"
      "yarn.scheduler.maximum-allocation-mb": "14096"
      "yarn.nodemanager.resource.memory-mb": "44096"
    mapred_site:
      "mapreduce.map.memory.mb": "512"
      "mapreduce.map.java.opts": "-Xmx819m"
      "mapreduce.reduce.memory.mb": "1024"
      "mapreduce.reduce.java.opts": "-Xmx1638m"
    mapred_env:
      HADOOP_JOB_HISTORYSERVER_HEAPSIZE: 900

- service: hive
  componentList:
    - component: client
      # 所有机器都安装client
      hostList: ["*"]
    - component: hiveserver
      hostList: ["fnode2.local","fnode3.local"]
    - component: metastore
      hostList: ["fnode1.local","fnode4.local"]

# 需要部署在hdfs-client hive-client的节点上
- service: impala
  componentList:
    - component: client
      # 所有机器都安装client
      hostList: ["*"]
    - component: catalogd
      hostList: ["fnode2.local"]
    - component: impalad
      hostList: ["fnode3.local"]
    - component: statestored
      hostList: ["fnode2.local"]
  configList:
    statestored:
      "mem_limit": "2g"
    impalad:
      "mem_limit": "2g"
    catalogd:
      "mem_limit": "2g"

- service: spark2
  componentList:
    - component: client
      # 所有机器都安装client
      # 需要部署在yarn的client节点
      hostList: ["*"]
    - component: jobhistoryserver
      hostList: ["fnode3.local"]
  configList:
    conf_spark_defaults:
      "spark.driver.memory": "2g"
      "spark.executor.memory": "2g"

- service: kyuubi
  componentList:
    - component: service
      hostList: ["fnode1.local"]
  configList:
    common:
      "spark.driver.memory": "4g"
      "spark.executor.memory": "4g"
      "spark.yarn.am.memory": "2g"

- service: hbase
  componentList:
    - component: client
      # client 需要部署在hdfs的client节点
      # 所有机器都安装client
      hostList: ["*"]
    - component: master
      # master 需要部署在hdfs的client节点
      hostList: ["fnode2.local", "fnode3.local"]
    - component: regionserver
      # 需要部署在datanode的节点
      hostList: ["fnode2.local", "fnode3.local"]

- service: knox
  componentList:
    - component: server
      hostList: ["fnode1.local", "fnode2.local"]
  configList:
    global:
    # 可以按需求调整成不同端口，以规避Nginx和Knox同时部署在一台主机上时监听端口冲突
    # nginx 单点模式通过nginx ip 地址访问 不通过主机名访问
      domain: "<nginx对外域名或ip>:8889"

- service: meta_worker
  componentList:
    - component: api_server
      hostList: ["fnode3.local"]
    - component: meta_server
      hostList: ["fnode3.local"]
      
- service: easyeagle
  componentList:
  # 选择任意一个节点，仅安装一个backend
  - component: backend
    hostList: ["fnode1.local"]
  # 选择default_yarn实例下任意一个装有yarn client组件的节点，仅安装一个parseservice,如果没有defalt_yarn，请咨询部署开发
  - component: parseservice
    hostList: ["fnode1.local"]
  # 选择default_yarn实例下所有装有yarn nodemanager组件的节点，如果没有defalt_yarn，请咨询部署开发
  - component: collector
    hostList: ["fnode2.local","fnode3.local", "fnode4.local"]
    
- service: smilodon_fsimage_audit
  componentList:
    - component: fsimage_oiv
      hostList: ["fnode1.local"]
    - component: upload_audit
      hostList: ["fnode1.local", "fnode2.local"]
    - component: upload_fsimage
      hostList: ["fnode1.local", "fnode2.local"]

- service: hadoop_meta
  componentList:
    - component: service
      # 需要部署在安装hdfs-client
      hostList: ["fnode4.local"]
    - component: scheduler
      # 部署在YARN ResourceManager节点上
      hostList: ["fnode1.local", "fnode2.local"]
    - component: kdc
      # 需要部署在kerberos的master节点, 且要安装hdfs-client
      hostList: ["fnode1.local"]

# 更改服务配置组中的meta.hadoop.clusters，保持和HDFS中fs.defaultFS定义的一致
- service: meta_service
  componentList:
    - component: service
      # 需要部署在安装hdfs-client
      hostList: ["fnode4.local"]

- service: bdms_meta
  componentList:
    - component: server
      hostList: ["fnode4.local"]

# 需要部署在安装hdfs-client
- service: mammut
  componentList:
    - component: executor
      hostList: ["fnode4.local"]
    - component: webserver
      hostList: ["fnode4.local"]

# 安装的机器需要有hdfs_client,hive_client,spark_client
- service: azkaban
  componentList:
    - component: exec
      hostList: ["fnode2.local", "fnode3.local"]
    - component: fc
      hostList: ["fnode2.local", "fnode3.local"]
    - component: web
      hostList: ["fnode2.local", "fnode3.local"]
    - component: lib
      hostList: ["fnode2.local", "fnode3.local"]

- service: easy_account
  version: 3.7.5.4
  componentList:
    - component: server
      hostList: ["fnode4.local"]

- service: prometheus
  componentList:
    - component: server
      hostList: ["fnode3.local"]

- service: easy_alert
  componentList:
    - component: server
      hostList: ["fnode3.local"]

- service: easy_access
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]
    - component: client
      hostList: ["fnode2.local", "fnode3.local"]

#  1）hbase配置 登录一个安装了hbase client的机器（使用hbase 1.2.6 版本）
#  2）es相关 确认下metahub使用的索引是否存在，例如
- service: easy_metahub
  componentList:
    - component: backend
      hostList: ["fnode4.local"]

- service: easy_transfer
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]
    - component: client
      # 所有机器都安装client
      hostList: ["fnode2.local", "fnode3.local"]

- service: easy_dmap
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]

- service: easy_design
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]

- service: easy_coop
  version: 1.2.2.5.1
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]

- service: easy_index
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]

- service: easy_tag
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]

- service: easy_taskops
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]

- service: easy_dqc
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]
    - component: client
      # 所有机器都安装client
      hostList: ["fnode2.local", "fnode3.local"]

- service: easy_test
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]
    - component: client
      hostList: ["fnode2.local", "fnode3.local"]

- service: easy_qa
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]

- service: easy_aac
  componentList:
    - component: server
      hostList: ["fnode3.local"]

- service: easy_ddl
  componentList:
    - component: server
      hostList: ["fnode3.local"]

- service: easy_dataservice
  componentList:
    - component: backend
      hostList: ["fnode3.local"]
    - component: frontend
      hostList: ["fnode3.local"]
    - component: server
      hostList: ["fnode3.local"]
    - component: monitor
      hostList: ["fnode3.local"]
    - component: orcserver
      hostList: ["fnode3.local"]
- service: kong
  componentList:
    - component: cassandra
      hostList: ["fnode1.local","fnode2.local"]
    - component: kong
      hostList: ["fnode1.local","fnode2.local"]
    - component: konga
      hostList: ["fnode1.local"]

- service: easy_console
  componentList:
    - component: backend
      hostList: ["fnode2.local"]
    - component: frontend
      hostList: ["fnode2.local"]

- service: easy_webmaster
  componentList:
    - component: frontend
      hostList: ["fnode2.local"]

- service: easy_standard
  componentList:
    - component: backend
      hostList: ["fnode2.local"]
    - component: frontend
      hostList: ["fnode2.local"]

- service: easy_metaweb
  componentList:
    - component: frontend
      hostList: ["fnode1.local"]

- service: easy_openapi
  componentList:
    - component: backend
      hostList: ["fnode1.local"]

- service: easy_flow
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]
    - component: engine
      hostList: ["fnode4.local"]

- service: easy_static
  componentList:
    - component: frontend
      hostList: ["fnode4.local"]
      
- service: easy_submit
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]
      
- service: easy_udf
  componentList:
    - component: backend
      hostList: ["fnode4.local"]
    - component: frontend
      hostList: ["fnode4.local"]

- id: ne-flink-1.10.0
  name: ne-flink-1.10.0
  service: flink
  version: ne-flink-1.10.0-1.1.8-scala-2.12
  componentList:
    - component: client
      hostList: ["fnode2.local"]
- id: ne-flink-1.12.4
  name: ne-flink-1.12.4
  service: flink
  version: ne-flink-1.12.4-1.1.7.1-scala-2.12
  componentList:
    - component: client
      hostList: ["fnode2.local"]
- id: ne-flink-1.13.3
  name: ne-flink-1.13.3
  service: flink
  version: ne-flink-1.13.3-1.0.1-scala-2.11
  componentList:
    - component: client
      hostList: ["fnode2.local"]
- id: ne-flink-1.14.0
  name: ne-flink-1.14.0
  service: flink
  version: ne-flink-1.14.0-1.0.4-scala-2.12
  componentList:
    - component: client
      hostList: ["fnode2.local"]
      
- id: plugin_cdc_ne-flink-1.13.3
  name: plugin_cdc_ne-flink-1.13.3
  service: flink_plugin
  version: cdc_ne-flink-1.13.3-1.0.1_scala2.11-release-3.9.4-2.1.7
  componentList:
    - component: client
      hostList: ["fnode2.local"]

- id: plugin_ne-flink-1.10.0
  name: plugin_ne-flink-1.10.0
  service: flink_plugin
  version: ne-flink-1.10.0-1.1.8_scala2.12_hive2.1.1-release-3.9.4-1.4.5
  componentList:
    - component: client
      hostList: ["fnode2.local"]

- id: plugin_ne-flink-1.12.4
  name: plugin_ne-flink-1.12.4
  service: flink_plugin
  version: ne-flink-1.12.4-1.1.7.1_scala2.12_hive2.1.1-release-3.9.4-1.4.5
  componentList:
    - component: client
      hostList: ["fnode2.local"]

- id: plugin_ne-flink-1.14.0
  name: plugin_ne-flink-1.14.0
  service: flink_plugin
  version: ne-flink-1.14.0-1.0.4_scala2.12_hive2.1.1-release-3.9.4-1.4.5.2
  componentList:
    - component: client
      hostList: ["fnode2.local"]

- id: ndi_ne-flink-1.13.3
  name: ndi_ne-flink-1.13.3
  service: flink_plugin
  version: ndi_ne-flink-1.13.3-1.0.1_scala2.11-release-3.0.0-1.0.0
  componentList:
    - component: client
      hostList: ["fnode2.local"]

- service: sloth
  componentList:
    - component: server
      hostList: ["fnode2.local"]
    - component: develop_web
      hostList: ["fnode2.local"]
  dependenceList:
    - ne-flink-1.10.0
    - ne-flink-1.12.4
    - ne-flink-1.13.3
    - ne-flink-1.14.0     
    - plugin_cdc_ne-flink-1.13.3
    - plugin_ne-flink-1.10.0
    - plugin_ne-flink-1.12.4
    - plugin_ne-flink-1.14.0
    - ndi_ne-flink-1.13.3

- service: realtime_submitter
  componentList:
    - component: submitter
      hostList: ["fnode2.local"]
  dependenceList:
    - ne-flink-1.10.0
    - ne-flink-1.12.4
    - ne-flink-1.13.3
    - ne-flink-1.14.0     
    - plugin_cdc_ne-flink-1.13.3
    - plugin_ne-flink-1.10.0
    - plugin_ne-flink-1.12.4
    - plugin_ne-flink-1.14.0
    - ndi_ne-flink-1.13.3

- service: realtime_debugger
  componentList:
    - component: plugin_server
      hostList: ["fnode2.local"]
  dependenceList:
    - ne-flink-1.10.0
    - ne-flink-1.12.4
    - ne-flink-1.13.3
    - ne-flink-1.14.0     
    - plugin_cdc_ne-flink-1.13.3
    - plugin_ne-flink-1.10.0
    - plugin_ne-flink-1.12.4
    - plugin_ne-flink-1.14.0
    - ndi_ne-flink-1.13.3

- service: realtime_ops
  componentList:
    - component: ops
      hostList: ["fnode2.local"]
    - component: web
      hostList: ["fnode2.local"]
      
- service: realtime_monitor
  componentList:
    - component: monitor
      hostList: ["fnode2.local"]


- service: realtime_portal
  componentList:
    - component: portal
      hostList: ["fnode2.local"]